name: Deploy

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      - uses: ./.github/workflows/install_zola

      - name: Build the webpage
        run: zola build

      - name: Upload as an artifact
        uses: actions/upload-artifact@v3
        with:
          name: webpage
          path: public/*

  # There is an action called `reviewdog/action-stylelint`. However, it requires `package.json` even if a project is not managed by npm.
  # That is why I install and run stylelint manually.
  check_css:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      - name: Install stylelint
        run: npm install -g stylelint postcss-sass

      - name: Run stylelint
        run: stylelint sass/**/*

  check_zola:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      - uses: ./.github/workflows/install_zola

      - name: Check source files
        run: zola check

  deploy:
    runs-on: ubuntu-latest

    needs: [build, check_css, check_zola]

    if: github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v2

      - name: Set the committer information
        run: |
          git config --global user.name 'Hiroki Tokunaga'
          git config --global user.email 'toku-sa-n@users.noreply.github.com'

      - name: Checkout to the `gh-pages` branch
        run: |
          git pull
          git checkout gh-pages

      - name: Clean up the directory
        run: rm -rf *

      - name: Download the artifact
        uses: actions/download-artifact@v3
        with:
          name: webpage

      - name: Commit
        run: |
          git add .
          git diff-index --quiet HEAD || git commit -m 'Deploy the website'

      - name: Push
        run: git push
